<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="elasticsearch 6.5에서 payload scoring 구현하기" /><meta name="author" content="하얀눈길" /><meta property="og:locale" content="en" /><meta name="description" content="elastic search가 payload score를 기본으로 지원하지 않는 이유를 잘 모르겠다. 요구하는 사람들이 꽤 있는 것 같은데.. 아무튼 없으니, 만들어야지…" /><meta property="og:description" content="elastic search가 payload score를 기본으로 지원하지 않는 이유를 잘 모르겠다. 요구하는 사람들이 꽤 있는 것 같은데.. 아무튼 없으니, 만들어야지…" /><link rel="canonical" href="https://www.irgroup.org/posts/payload-score-in-elasticsearch-6.5/" /><meta property="og:url" content="https://www.irgroup.org/posts/payload-score-in-elasticsearch-6.5/" /><meta property="og:site_name" content="하얀눈길 블로그" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2018-11-21T00:00:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="elasticsearch 6.5에서 payload scoring 구현하기" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@하얀눈길" /><meta name="google-site-verification" content="i7DonAsg2XevX1vbo0yJyGpmzhwsylBrYop20xy_Z48" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"하얀눈길"},"headline":"elasticsearch 6.5에서 payload scoring 구현하기","dateModified":"2021-12-27T18:05:38+09:00","datePublished":"2018-11-21T00:00:00+09:00","description":"elastic search가 payload score를 기본으로 지원하지 않는 이유를 잘 모르겠다. 요구하는 사람들이 꽤 있는 것 같은데.. 아무튼 없으니, 만들어야지…","url":"https://www.irgroup.org/posts/payload-score-in-elasticsearch-6.5/","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.irgroup.org/posts/payload-score-in-elasticsearch-6.5/"},"@context":"https://schema.org"}</script><title>elasticsearch 6.5에서 payload scoring 구현하기 | 하얀눈길 블로그</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="하얀눈길 블로그"><meta name="application-name" content="하얀눈길 블로그"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8993100314477491" crossorigin="anonymous"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/ir.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">하얀눈길 블로그</a></div><div class="site-subtitle" style="letter-spacing: -0.02em;">반갑습니다. 하얀눈길입니다.<br> 잊어버리기 전에 기록하려 합니다.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/focuschange" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://www.facebook.com/focuschange" aria-label="facebook" target="_blank" rel="noopener"> <i class="fab fa-facebook"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['focuschange','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>elasticsearch 6.5에서 payload scoring 구현하기</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>elasticsearch 6.5에서 payload scoring 구현하기</h1><div class="post-meta text-muted"><div> By <em> <a href="https://github.com/focuschange">하얀눈길</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" date="2018-11-21 00:00:00 +0900" data-toggle="tooltip" data-placement="bottom" title="Wed, Nov 21, 2018, 12:00 AM +0900" >Nov 21, 2018</em> </span> <span> Updated <em class="timeago" date="2021-12-27 18:05:38 +0900 " data-toggle="tooltip" data-placement="bottom" title="Mon, Dec 27, 2021, 6:05 PM +0900" >Dec 27, 2021</em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3097 words"> <em>17 min</em> read</span></div></div></div><div class="post-content"><blockquote><p>elastic search가 payload score를 기본으로 지원하지 않는 이유를 잘 모르겠다. 요구하는 사람들이 꽤 있는 것 같은데.. 아무튼 없으니, 만들어야지…</p></blockquote><script async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8993100314477491" crossorigin="anonymous"></script><p><ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-8993100314477491" data-ad-slot="6115278830"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script></p><h1 id="introduction">Introduction</h1><p>payload score란 문서의 키워드에 절대적인 값을 주어 검색을 할 때 이 절대적인 값으로 정렬 등 부가적인 scoring이 가능하도록 구성하는 것을 말한다. 이는 루씬에서 아주 예전부터 지원하던 기능으로 알고 있으며, solr같은 경우는 항상 기본 기능으로 제공한다.</p><p>헌데, elasticsearch는 아주 예전 버전부터 payload score를 지원하지 않고 있다. 이상한 것은 색인은 할 수 있도록 해 두었다는 것이다. 색인된 payload를 어디서 쓰고 있는지 아직 알 수 없지만, 색인만 하고 검색에 사용할 수 없으니 반쪽짜리 기능이 되어 버렸다. 아니 아예 쓸모없는 기능이 되어 버렸다. 대다수의 개발자들이 이런 문제로 인해 플러그인을 개발하여 자체적으로 사용하고 있는 것 같다. 하지만, elastic쪽에서 자신들의 전략인지는 모르겠지만 플러그인 개발조차 아주 어렵게 해 둔 것 같다. 버전업이 되면서 기존 플러그인에 대한 호환성을 전혀 고려해 주지 않기 때문에, 매 버전마다 새로 개발해야 한다. 맘에 들지 않는 정책이지만, 뭐.. 어쩔수 없다. 만들어야지..</p><p><strong>본 문서는 elasticsearch 6.5.0을 기준으로 작성된 plug-in 개발에 대해 설명한다.</strong> <a href="https://github.com/focuschange/elasticsearch-payload-score">여기</a>에 전체 소스가 있으니 참고하기 바란다.</p><h1 id="index">index</h1><p>색인 데이터를 구성할 때, 특정 키워드에 가중치를 주기 위해 다음과 같이 field를 구성한다고 가정하자</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="p">{</span>
  <span class="dl">"</span><span class="s2">doc_id</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">1</span><span class="dl">"</span>
  <span class="dl">"</span><span class="s2">key</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span>
    <span class="dl">"</span><span class="s2">yellow|3 blue|1.1 red|1</span><span class="dl">"</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></table></code></div></div><p>위 예제는 문서 1번에서 key 필드의 키워드들에 대해서 <code class="language-plaintext highlighter-rouge">yellow</code>라는 키워드는 가중치를 <code class="language-plaintext highlighter-rouge">3</code>으로 주고, <code class="language-plaintext highlighter-rouge">blue</code>는 <code class="language-plaintext highlighter-rouge">1.1</code>, <code class="language-plaintext highlighter-rouge">red</code>는 <code class="language-plaintext highlighter-rouge">1</code>로 주기 위해 구성해 본 것이다. 우선은 이런 형식의 필드값을 색인하기 위한 tokenizer가 필요하다. elasticsearch는 이런 토큰을 위해 <code class="language-plaintext highlighter-rouge">delimited_payload</code>라는 token filter를 제공한다.</p><p>자세한 사항은 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-delimited-payload-tokenfilter.html">여기</a>를 참조하자.</p><p>이전 버전에서는 <code class="language-plaintext highlighter-rouge">delimited_payload_filter</code>라는 이름으로 사용됐는데, 바뀌었다. (<em>이런.. 버전업 되면 또 어떻게 변할지 모른다.</em>)</p><p>settings.analysis.analyzer에 tokenizer를 설정해 두면 된다.</p><p>mappings에서는 해당 필드에 term_vector를 설정해야 한다. payload 값은 term_vector에 들어가게 되는데, term offset 다음에 저장되는 것으로 보여진다. 다음과 같이 지정하면 된다.</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>	<span class="dl">"</span><span class="s2">term_vector</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">with_positions_offsets_payloads</span><span class="dl">"</span>
</pre></table></code></div></div><p>자세한 내용은 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/term-vector.html">여기</a>를 확인하자. 헌데, 공식 문서에 <code class="language-plaintext highlighter-rouge">with_positions_offsets_payloads</code> 란 것이 없다. (<em>뭐지??</em>) 쓰면 된다.</p><p>다음은 전체적인 settings, mappings 내용이다.</p><h2 id="elasticsearch-setting--mapping">elasticsearch setting &amp; mapping<a href="#elasticsearch-setting--mapping"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-javascript highlighter-rouge"><div class="code-header"> <span label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre><td class="rouge-code"><pre><span class="p">{</span>
  <span class="dl">"</span><span class="s2">settings</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">index</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">number_of_shards</span><span class="dl">"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
      <span class="dl">"</span><span class="s2">number_of_replicas</span><span class="dl">"</span><span class="p">:</span> <span class="mi">0</span>
    <span class="p">},</span>
    <span class="dl">"</span><span class="s2">analysis</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">analyzer</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">payload_analyzer</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
          <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">custom</span><span class="dl">"</span><span class="p">,</span>
          <span class="dl">"</span><span class="s2">tokenizer</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">payload_tokenizer</span><span class="dl">"</span><span class="p">,</span>
          <span class="dl">"</span><span class="s2">filter</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span>
            <span class="dl">"</span><span class="s2">payload_filter</span><span class="dl">"</span>
          <span class="p">]</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="dl">"</span><span class="s2">tokenizer</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">payload_tokenizer</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
          <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">whitespace</span><span class="dl">"</span><span class="p">,</span>
          <span class="dl">"</span><span class="s2">max_token_length</span><span class="dl">"</span><span class="p">:</span> <span class="mi">64</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="dl">"</span><span class="s2">filter</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">payload_filter</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
          <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">delimited_payload</span><span class="dl">"</span><span class="p">,</span>
          <span class="dl">"</span><span class="s2">encoding</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">float</span><span class="dl">"</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="dl">"</span><span class="s2">mappings</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">_doc</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">properties</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">key</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
          <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">text</span><span class="dl">"</span><span class="p">,</span>
          <span class="dl">"</span><span class="s2">analyzer</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">payload_analyzer</span><span class="dl">"</span><span class="p">,</span>
          <span class="dl">"</span><span class="s2">term_vector</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">with_positions_offsets_payloads</span><span class="dl">"</span><span class="p">,</span>
          <span class="dl">"</span><span class="s2">store</span><span class="dl">"</span><span class="p">:</span> <span class="kc">true</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h1 id="search">search</h1><p>이제 우리가 필요로 하는 payload score 검색 기능을 구현하기 위해 plug-in을 만들어야 한다. script score 기능으로 plug-in을 만들 것이며, 기본적인 소스는 <a href="https://github.com/elastic/elasticsearch/tree/master/plugins/examples/script-expert-scoring">여기</a>를 참조하면 된다. 공식 샘플소스는 gradle로 되어 있는데, 아마도 모두 클로닝해서 컴파일 하면 에러가 날 것이다. java 11을 설치해야 한다.</p><p>maven dependency는 다음과 같다.</p><div class="language-xml highlighter-rouge"><div class="code-header"> <span label-text="XML"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="nt">&lt;dependencies&gt;</span>  
	<span class="nt">&lt;dependency&gt;</span>
		<span class="nt">&lt;groupId&gt;</span>org.elasticsearch<span class="nt">&lt;/groupId&gt;</span>  
		<span class="nt">&lt;artifactId&gt;</span>elasticsearch<span class="nt">&lt;/artifactId&gt;</span>  
		<span class="nt">&lt;version&gt;</span>6.5.0<span class="nt">&lt;/version&gt;</span>  
		<span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>  
	<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;/dependencies&gt;</span>
</pre></table></code></div></div><p>6.x버전이 되면서 script plug-in 기본 인터페이스가 ScriptPlugin으로 변경된 것 같다.(<em>사실 이전 버전은 잘 모른다. 5.x버전과 비교해 보니 완전히 바뀌어 있었다</em>)</p><h2 id="plug-in-class-생성">Plug-in Class 생성<a href="#plug-in-class-생성"><i class="fas fa-hashtag"></i></a></h2></h2><p>아래는 plug-in 생성을 위한 코드이다. 코드 중에 _SOURCE_VALUE와 _LANG_VALUE를 통해 script score를 명시할 것이다.</p><p>PayloadScorePlugin.java</p><div class="language-java highlighter-rouge"><div class="code-header"> <span label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PayloadScorePlugin</span> <span class="kd">extends</span> <span class="nc">Plugin</span> <span class="kd">implements</span> <span class="nc">ScriptPlugin</span> <span class="o">{</span>  
  
  <span class="nd">@Override</span>  
  <span class="kd">public</span> <span class="nc">ScriptEngine</span> <span class="nf">getScriptEngine</span><span class="o">(</span><span class="nc">Settings</span> <span class="n">settings</span><span class="o">,</span> <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">ScriptContext</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">contexts</span><span class="o">)</span> <span class="o">{</span>  
      <span class="k">return</span> <span class="k">new</span> <span class="nf">WmpScriptEngine</span><span class="o">();</span>  
  <span class="o">}</span>  
  
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">WmpScriptEngine</span> <span class="kd">implements</span> <span class="nc">ScriptEngine</span> <span class="o">{</span>  
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">_SOURCE_VALUE</span> <span class="o">=</span> <span class="s">"payload_score"</span><span class="o">;</span>  
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">_LANG_VALUE</span> <span class="o">=</span> <span class="s">"irgroup"</span><span class="o">;</span>  
  
  <span class="nd">@Override</span>  
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getType</span><span class="o">()</span> <span class="o">{</span>  
         <span class="k">return</span> <span class="n">_LANG_VALUE</span><span class="o">;</span>  
  <span class="o">}</span>  
  
  <span class="nd">@Override</span>  
  <span class="kd">public</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">compile</span><span class="o">(</span><span class="nc">String</span> <span class="n">scriptName</span><span class="o">,</span> <span class="nc">String</span> <span class="n">scriptSource</span><span class="o">,</span> <span class="nc">ScriptContext</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">,</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>  
  
         <span class="k">if</span> <span class="o">(!</span><span class="n">context</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="nc">ScoreScript</span><span class="o">.</span><span class="na">CONTEXT</span><span class="o">))</span> <span class="o">{</span>  
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="n">getType</span><span class="o">()</span>  
                  <span class="o">+</span> <span class="s">" scripts cannot be used for context ["</span>  
				  <span class="o">+</span> <span class="n">context</span><span class="o">.</span><span class="na">name</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">);</span>  
		 <span class="o">}</span>  
  
         <span class="c1">// we use the script "source" as the script identifier  </span>
		  <span class="k">if</span> <span class="o">(</span><span class="n">_SOURCE_VALUE</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">scriptSource</span><span class="o">))</span> <span class="o">{</span>  
		         <span class="nc">ScoreScript</span><span class="o">.</span><span class="na">Factory</span> <span class="n">factory</span> <span class="o">=</span> <span class="nl">PayloadScoreFactory:</span><span class="o">:</span><span class="k">new</span><span class="o">;</span>  
				 <span class="k">return</span> <span class="n">context</span><span class="o">.</span><span class="na">factoryClazz</span><span class="o">.</span><span class="na">cast</span><span class="o">(</span><span class="n">factory</span><span class="o">);</span>  
		  <span class="o">}</span>  
	      <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"Unknown script name "</span> <span class="o">+</span> <span class="n">scriptSource</span><span class="o">);</span>  
	  <span class="o">}</span>  
  
      <span class="nd">@Override</span>  
	  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">close</span><span class="o">()</span> <span class="o">{</span>  
	         <span class="c1">// optionally close resources  </span>
	  <span class="o">}</span>  
   <span class="o">}</span>  
<span class="o">}</span>
</pre></table></code></div></div><p>PayloadScoreFactory.java</p><div class="language-java highlighter-rouge"><div class="code-header"> <span label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">PayloadScoreFactory</span> <span class="kd">implements</span> <span class="nc">ScoreScript</span><span class="o">.</span><span class="na">LeafFactory</span> <span class="o">{</span>  
	<span class="kd">private</span> <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">params</span><span class="o">;</span>  
	<span class="kd">private</span> <span class="kd">final</span> <span class="nc">SearchLookup</span> <span class="n">lookup</span><span class="o">;</span>  
	<span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">field</span><span class="o">;</span>  
	<span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">term</span><span class="o">;</span>  

	<span class="kd">public</span> <span class="nf">PayloadScoreFactory</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">params</span><span class="o">,</span> <span class="nc">SearchLookup</span> <span class="n">lookup</span><span class="o">)</span> <span class="o">{</span>  
  
		<span class="k">if</span> <span class="o">(</span><span class="n">params</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="s">"field"</span><span class="o">)</span> <span class="o">==</span> <span class="kc">false</span><span class="o">)</span> <span class="o">{</span>  
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"Missing parameter [field]"</span><span class="o">);</span>  
		<span class="o">}</span>  
		<span class="k">if</span> <span class="o">(</span><span class="n">params</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="s">"term"</span><span class="o">)</span> <span class="o">==</span> <span class="kc">false</span><span class="o">)</span> <span class="o">{</span>  
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"Missing parameter [term]"</span><span class="o">);</span>  
		<span class="o">}</span>  
		<span class="k">this</span><span class="o">.</span><span class="na">params</span> <span class="o">=</span> <span class="n">params</span><span class="o">;</span>  
		<span class="k">this</span><span class="o">.</span><span class="na">lookup</span> <span class="o">=</span> <span class="n">lookup</span><span class="o">;</span>  
		<span class="n">field</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"field"</span><span class="o">).</span><span class="na">toString</span><span class="o">();</span>  
		<span class="n">term</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"term"</span><span class="o">).</span><span class="na">toString</span><span class="o">();</span>  
	<span class="o">}</span>  
  
	<span class="nd">@Override</span>  
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">needs_score</span><span class="o">()</span> <span class="o">{</span>  
		<span class="k">return</span> <span class="kc">false</span><span class="o">;</span>  
	<span class="o">}</span>  
  
	<span class="nd">@Override</span>  
	<span class="kd">public</span> <span class="nc">ScoreScript</span> <span class="nf">newInstance</span><span class="o">(</span><span class="nc">LeafReaderContext</span> <span class="n">context</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>  
  
		<span class="nc">PostingsEnum</span> <span class="n">postings</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">reader</span><span class="o">().</span><span class="na">postings</span><span class="o">(</span><span class="k">new</span> <span class="nc">Term</span><span class="o">(</span><span class="n">field</span><span class="o">,</span> <span class="n">term</span><span class="o">),</span> <span class="nc">PostingsEnum</span><span class="o">.</span><span class="na">PAYLOADS</span><span class="o">);</span>  
  
		<span class="k">if</span> <span class="o">(</span><span class="n">postings</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>  
			<span class="k">return</span> <span class="k">new</span> <span class="nf">ScoreScript</span><span class="o">(</span><span class="n">params</span><span class="o">,</span> <span class="n">lookup</span><span class="o">,</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>  
				<span class="nd">@Override</span>  
				<span class="kd">public</span> <span class="kt">double</span> <span class="nf">execute</span><span class="o">()</span> <span class="o">{</span>  
				<span class="k">return</span> <span class="mf">0.0d</span><span class="o">;</span>  
			  <span class="o">}</span>  
			<span class="o">};</span>  
		<span class="o">}</span>  
  
		<span class="k">return</span> <span class="k">new</span> <span class="nf">ScoreScript</span><span class="o">(</span><span class="n">params</span><span class="o">,</span> <span class="n">lookup</span><span class="o">,</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>  
			<span class="kt">int</span> <span class="n">currentDocid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>  
  
			<span class="nd">@Override</span>  
			<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDocument</span><span class="o">(</span><span class="kt">int</span> <span class="n">docid</span><span class="o">)</span> <span class="o">{</span>  
	            <span class="cm">/*  
	            * advance has undefined behavior calling with 
	            * a docid &lt;= its current docid 
	            */</span>  
	            <span class="k">if</span> <span class="o">(</span><span class="n">postings</span><span class="o">.</span><span class="na">docID</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">docid</span><span class="o">)</span> <span class="o">{</span>  
					<span class="k">try</span> <span class="o">{</span>  
						<span class="n">postings</span><span class="o">.</span><span class="na">advance</span><span class="o">(</span><span class="n">docid</span><span class="o">);</span>  
					<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>  
						<span class="k">throw</span> <span class="k">new</span> <span class="nf">UncheckedIOException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>  
					<span class="o">}</span>  
				<span class="o">}</span>  
	            <span class="n">currentDocid</span> <span class="o">=</span> <span class="n">docid</span><span class="o">;</span>  
			<span class="o">}</span>  
  
			<span class="nd">@Override</span>  
			<span class="kd">public</span> <span class="kt">double</span> <span class="nf">execute</span><span class="o">()</span> <span class="o">{</span>  
  
				<span class="k">if</span> <span class="o">(</span><span class="n">postings</span><span class="o">.</span><span class="na">docID</span><span class="o">()</span> <span class="o">!=</span> <span class="n">currentDocid</span><span class="o">)</span> <span class="o">{</span>  
					<span class="cm">/*  
					* advance moved past the current doc, so this doc 
					* has no occurrences of the term 
					*/</span>  
					<span class="k">return</span> <span class="mf">0.0d</span><span class="o">;</span>  
				 <span class="o">}</span>  
				<span class="k">try</span> <span class="o">{</span>  
					<span class="kt">int</span> <span class="n">freq</span> <span class="o">=</span> <span class="n">postings</span><span class="o">.</span><span class="na">freq</span><span class="o">();</span>  
					<span class="kt">float</span> <span class="n">sum_payload</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="o">;</span>  
					<span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">freq</span><span class="o">;</span> <span class="n">i</span> <span class="o">++)</span>  
					<span class="o">{</span>  
						<span class="n">postings</span><span class="o">.</span><span class="na">nextPosition</span><span class="o">();</span>  
						<span class="nc">BytesRef</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">postings</span><span class="o">.</span><span class="na">getPayload</span><span class="o">();</span>  
						<span class="k">if</span><span class="o">(</span><span class="n">payload</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>  
							<span class="n">sum_payload</span> <span class="o">+=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">payload</span><span class="o">.</span><span class="na">bytes</span><span class="o">,</span> <span class="n">payload</span><span class="o">.</span><span class="na">offset</span><span class="o">,</span> <span class="n">payload</span><span class="o">.</span><span class="na">length</span><span class="o">)</span>  
									<span class="o">.</span><span class="na">order</span><span class="o">(</span><span class="nc">ByteOrder</span><span class="o">.</span><span class="na">BIG_ENDIAN</span><span class="o">).</span><span class="na">getFloat</span><span class="o">();</span>  
						<span class="o">}</span>  
					<span class="o">}</span>  
					
					<span class="k">return</span> <span class="n">sum_payload</span><span class="o">;</span>  
				<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>  
					<span class="k">throw</span> <span class="k">new</span> <span class="nf">UncheckedIOException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>  
				<span class="o">}</span>  
			<span class="o">}</span>  
		<span class="o">};</span>  
	<span class="o">}</span>  
<span class="o">}</span>
</pre></table></code></div></div><p>PayloadScorePlugin class는 script score 기능을 추가하기 위한 plugin 설정 정보를 담는다. 실제 score는 PayloadScoreFactory class에서 계산하게 된다.</p><p>index field에는 동일한 term이 여러개 있을 수 있으며, 각 term마다 payload값을 다르게 줄 수 있다. 따라서 이를 모두 합산하여 score를 주기 위해 posting을 순회하면서 합산한다.</p><p>소스는 짧고 간단하니, 상세한 설명은.. 패스~</p><h1 id="컴파일-및-설치">컴파일 및 설치</h1><p>컴파일은 다음과 같이 하면 된다.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>maven clean package
</pre></table></code></div></div><p>zip파일이 잘 만들어졌다면 다음과 같이 설치한다.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="c"># 이전 설치된 플러그인 삭제</span>
<span class="nv">$ </span>ES_HOME/bin/elasticsearch-plugin remove payload_score

<span class="c"># 플러그인 등록</span>
<span class="nv">$ </span>ES_HOME/bin/elasticsearch-plugin <span class="nb">install </span>file:///PROJECT_HOME/releases/payload_score-1.0.0.zip
</pre></table></code></div></div><p>물론 elasticsearch를 중단한 후 재구동해야 한다. 재구동 할 때, 다음 메세지가 출력되면 성공적으로 등록된 것이다.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>[2018-11-21T22:04:11,793][INFO ][o.e.p.PluginsService     ] [standalone] loaded plugin [payload_score]
</pre></table></code></div></div><h1 id="example-test">example test</h1><p>테스트를 위해 아래와 같이 간단히 bulk index용 컬렉션을 만들었다.</p><p><strong>test_collection.json</strong></p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="p">{</span> <span class="dl">"</span><span class="s2">index</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span> <span class="dl">"</span><span class="s2">_index</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">payload-test</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">_type</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">_doc</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">_id</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">1</span><span class="dl">"</span> <span class="p">}</span> <span class="p">}</span>  
<span class="p">{</span> <span class="dl">"</span><span class="s2">key</span><span class="dl">"</span> <span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">yellow|3 blue|1.1 red|1</span><span class="dl">"</span> <span class="p">]</span> <span class="p">}</span>  
<span class="p">{</span> <span class="dl">"</span><span class="s2">index</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span> <span class="dl">"</span><span class="s2">_index</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">payload-test</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">_type</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">_doc</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">_id</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">2</span><span class="dl">"</span> <span class="p">}</span> <span class="p">}</span>  
<span class="p">{</span> <span class="dl">"</span><span class="s2">key</span><span class="dl">"</span> <span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">yellow|2 yellow|2.5 blue|1 red|5</span><span class="dl">"</span><span class="p">]</span> <span class="p">}</span>  
<span class="p">{</span> <span class="dl">"</span><span class="s2">index</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span> <span class="dl">"</span><span class="s2">_index</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">payload-test</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">_type</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">_doc</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">_id</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">3</span><span class="dl">"</span> <span class="p">}</span> <span class="p">}</span>  
<span class="p">{</span> <span class="dl">"</span><span class="s2">key</span><span class="dl">"</span> <span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">yellow|10 blue|2 red|4.3</span><span class="dl">"</span> <span class="p">]</span> <span class="p">}</span>  
<span class="p">{</span> <span class="dl">"</span><span class="s2">index</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span> <span class="dl">"</span><span class="s2">_index</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">payload-test</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">_type</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">_doc</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">_id</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">4</span><span class="dl">"</span> <span class="p">}</span> <span class="p">}</span>  
<span class="p">{</span> <span class="dl">"</span><span class="s2">key</span><span class="dl">"</span> <span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">dark_yellow|10 blue|3 red|4.2</span><span class="dl">"</span> <span class="p">]</span> <span class="p">}</span>  
<span class="p">{</span> <span class="dl">"</span><span class="s2">index</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span> <span class="dl">"</span><span class="s2">_index</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">payload-test</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">_type</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">_doc</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">_id</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">5</span><span class="dl">"</span> <span class="p">}</span> <span class="p">}</span>  
<span class="p">{</span> <span class="dl">"</span><span class="s2">key</span><span class="dl">"</span> <span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">yellow|102020.95 blue red|1</span><span class="dl">"</span> <span class="p">]</span> <span class="p">}</span>
</pre></table></code></div></div><p>색인 생성 및 벌크로드를 아래 스크립트로 간단히 생성하였으니, 유용하게.. (<em>쿨럭~</em>)</p><p><strong>create_index.sh</strong></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
</pre><td class="rouge-code"><pre><span class="c">#!/bin/bash  </span>
  
<span class="nv">OPTIND</span><span class="o">=</span>1 <span class="c"># Reset in case getopts has been used previously in the shell.  </span>
  
<span class="nv">INDEX_NAME</span><span class="o">=</span><span class="s1">'payload_test'</span>  
<span class="nv">ES_HOST</span><span class="o">=</span><span class="s1">'localhost:9200'</span>  
<span class="nv">SET_MAP</span><span class="o">=</span><span class="s1">'set-map.json'</span>  
  
<span class="k">function </span><span class="nb">help</span> <span class="o">{</span>  
  <span class="nb">echo</span> <span class="s2">"Usage : </span><span class="nv">$0</span><span class="s2"> [options]"</span>  
  <span class="nb">echo</span> <span class="s2">"    -h|-?                 help"</span>  
  <span class="nb">echo</span> <span class="s2">"    -H {host:port}        host:port. </span><span class="se">\"</span><span class="s2">localhost:9200</span><span class="se">\"</span><span class="s2"> is default "</span>  
  <span class="nb">echo</span> <span class="s2">"    -i {index}            index"</span>  
  <span class="nb">echo</span> <span class="s2">"    -s {set-map_file}     setting &amp; mapping json file"</span>  
  <span class="nb">echo</span> <span class="s2">""</span>  
<span class="o">}</span>  
  
<span class="k">if</span> <span class="o">[</span> <span class="s2">"$#"</span> <span class="nt">-eq</span> 0 <span class="o">]</span><span class="p">;</span> <span class="k">then  
  </span><span class="nb">help  
  exit</span><span class="p">;</span>  
<span class="k">fi  
  
while </span><span class="nb">getopts</span> <span class="s2">"H:i:s:"</span> opt<span class="p">;</span> <span class="k">do  
 case</span> <span class="s2">"</span><span class="nv">$opt</span><span class="s2">"</span> <span class="k">in</span>  
  <span class="se">\h</span><span class="p">|</span><span class="se">\?</span><span class="p">)</span>  
        <span class="nb">help  
  exit </span>0  
  <span class="p">;;</span>  
  H<span class="p">)</span> <span class="nv">ES_HOST</span><span class="o">=</span><span class="nv">$OPTARG</span>  
        <span class="p">;;</span>  
  i<span class="p">)</span> <span class="nv">INDEX_NAME</span><span class="o">=</span><span class="nv">$OPTARG</span>  
        <span class="p">;;</span>  
  s<span class="p">)</span> <span class="nv">SET_MAP</span><span class="o">=</span><span class="nv">$OPTARG</span>  
        <span class="p">;;</span>  
  :<span class="p">)</span>  
        <span class="nb">echo</span> <span class="s2">"Option -</span><span class="nv">$OPTARG</span><span class="s2"> requires an argument."</span> <span class="o">&gt;</span>&amp;2  
  <span class="nb">echo</span> <span class="s2">""</span>  
  <span class="nb">help  
  exit </span>0  
  <span class="p">;;</span>  
 esacdone  
  
<span class="nb">shift</span> <span class="k">$((</span>OPTIND-1<span class="k">))</span>  
<span class="o">[</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"--"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">shift  
  
echo</span> <span class="s1">'* remove old index'</span>  
curl <span class="nt">-X</span> DELETE http://<span class="k">${</span><span class="nv">ES_HOST</span><span class="k">}</span>/<span class="k">${</span><span class="nv">INDEX_NAME</span><span class="k">}</span>?pretty  
<span class="nb">echo  
echo  
  
  
echo</span> <span class="s1">'* create index'</span>  
curl <span class="nt">-H</span> <span class="s1">'Content-Type: application/json'</span> <span class="nt">-XPUT</span> http://<span class="k">${</span><span class="nv">ES_HOST</span><span class="k">}</span>/<span class="k">${</span><span class="nv">INDEX_NAME</span><span class="k">}</span>?pretty <span class="nt">--data-binary</span> @<span class="k">${</span><span class="nv">SET_MAP</span><span class="k">}</span>  
<span class="nb">echo  
echo  
  
  
echo</span> <span class="s1">'* index info'</span>  
curl <span class="nt">-XGET</span> http://<span class="k">${</span><span class="nv">ES_HOST</span><span class="k">}</span>/<span class="k">${</span><span class="nv">INDEX_NAME</span><span class="k">}</span>?pretty  
<span class="nb">echo  
  
echo</span> <span class="s1">'* bulk insert'</span>  
curl <span class="nt">-H</span> <span class="s1">'Content-Type: application/json'</span> <span class="nt">-X</span> POST http://<span class="k">${</span><span class="nv">ES_HOST</span><span class="k">}</span>/_bulk?pretty <span class="nt">--data-binary</span> @test_collection.json  
<span class="nb">echo</span>
</pre></table></code></div></div><p>아래와 같이 사용하면 된다.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>./create_index.sh <span class="nt">-i</span> payload-test <span class="nt">-s</span> payload_set-map.json
</pre></table></code></div></div><p>정상적이라면 localhost:9200 클러스터에 payload-test index가 생성되어 있을 것이다. 다음과 같이 test_collection을 색인해 보자</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>curl <span class="nt">-H</span> <span class="s1">'Content-Type: application/json'</span> <span class="nt">-X</span> POST http://localhost:9200/_bulk?pretty <span class="nt">--data-binary</span> @test_collection.json
</pre></table></code></div></div><p>색인된 payload 값을 확인해 보자</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>curl <span class="nt">-H</span> <span class="s1">'Content-Type: application/json'</span> <span class="nt">-XGET</span> localhost:9200/payload-test/_doc/1/_termvectors?pretty
</pre></table></code></div></div><p>아마도 아래처럼 나오게 될 것이다.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre><td class="rouge-code"><pre><span class="o">{</span>
  <span class="s2">"_index"</span> : <span class="s2">"payload-test"</span>,
  <span class="s2">"_type"</span> : <span class="s2">"_doc"</span>,
  <span class="s2">"_id"</span> : <span class="s2">"1"</span>,
  <span class="s2">"_version"</span> : 2,
  <span class="s2">"found"</span> : <span class="nb">true</span>,
  <span class="s2">"took"</span> : 0,
  <span class="s2">"term_vectors"</span> : <span class="o">{</span>
    <span class="s2">"key"</span> : <span class="o">{</span>
      <span class="s2">"field_statistics"</span> : <span class="o">{</span>
        <span class="s2">"sum_doc_freq"</span> : 12,
        <span class="s2">"doc_count"</span> : 4,
        <span class="s2">"sum_ttf"</span> : 13
      <span class="o">}</span>,
      <span class="s2">"terms"</span> : <span class="o">{</span>
        <span class="s2">"blue"</span> : <span class="o">{</span>
          <span class="s2">"term_freq"</span> : 1,
          <span class="s2">"tokens"</span> : <span class="o">[</span>
            <span class="o">{</span>
              <span class="s2">"position"</span> : 1,
              <span class="s2">"start_offset"</span> : 9,
              <span class="s2">"end_offset"</span> : 17,
              <span class="s2">"payload"</span> : <span class="s2">"P4zMzQ=="</span>
            <span class="o">}</span>
          <span class="o">]</span>
        <span class="o">}</span>,
        <span class="s2">"red"</span> : <span class="o">{</span>
          <span class="s2">"term_freq"</span> : 1,
          <span class="s2">"tokens"</span> : <span class="o">[</span>
            <span class="o">{</span>
              <span class="s2">"position"</span> : 2,
              <span class="s2">"start_offset"</span> : 18,
              <span class="s2">"end_offset"</span> : 23,
              <span class="s2">"payload"</span> : <span class="s2">"P4AAAA=="</span>
            <span class="o">}</span>
          <span class="o">]</span>
        <span class="o">}</span>,
        <span class="s2">"yellow"</span> : <span class="o">{</span>
          <span class="s2">"term_freq"</span> : 1,
          <span class="s2">"tokens"</span> : <span class="o">[</span>
            <span class="o">{</span>
              <span class="s2">"position"</span> : 0,
              <span class="s2">"start_offset"</span> : 0,
              <span class="s2">"end_offset"</span> : 8,
              <span class="s2">"payload"</span> : <span class="s2">"QEAAAA=="</span>
            <span class="o">}</span>
          <span class="o">]</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>tokens에 보면 payload 값이 보인다. 문서는 float으로 구성했지만, 엔진에서 base64로 인코딩한다.</p><p>자.. 이제 대망의 payload score 검색을 해 보자</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="nv">$ </span>curl <span class="nt">-H</span> <span class="s1">'Content-Type: application/json'</span> <span class="nt">-X</span> POST <span class="s1">'localhost:9200/payload-test/_search?pretty'</span> <span class="nt">-d</span> <span class="s1">'
{
  "query": {
    "function_score": {
      "query": {
        "match": {
          "key": "yellow"
        }
      },
      "functions": [
        {
          "script_score": {
            "script": {
                "source": "payload_score",
                "lang" : "irgroup",
                "params": {
                    "field": "key",
                    "term": "yellow"
                }
            }
          }
        }
      ]
    }
  }
}
'</span>
</pre></table></code></div></div><p>fuction_score query를 사용하여 검색한다. script_score에서 source, lang을 프로그램에서 설정한 값으로 입력하고, params 부분에서는 검색대상 필드와 검색할 키워드를 입력한다.</p><p>결과는 다음과 같이 나올 것이다.</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre><td class="rouge-code"><pre><span class="p">{</span>
  <span class="dl">"</span><span class="s2">took</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">73</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">timed_out</span><span class="dl">"</span> <span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">_shards</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">total</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">successful</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">skipped</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">failed</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">0</span>
  <span class="p">},</span>
  <span class="dl">"</span><span class="s2">hits</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">total</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">max_score</span><span class="dl">"</span> <span class="p">:</span> <span class="mf">102020.95</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">hits</span><span class="dl">"</span> <span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="dl">"</span><span class="s2">_index</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">payload-test</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">_type</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">_doc</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">_id</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">5</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">_score</span><span class="dl">"</span> <span class="p">:</span> <span class="mf">102020.95</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">_source</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
          <span class="dl">"</span><span class="s2">key</span><span class="dl">"</span> <span class="p">:</span> <span class="p">[</span>
            <span class="dl">"</span><span class="s2">yellow|102020.95 blue red|1</span><span class="dl">"</span>
          <span class="p">]</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="dl">"</span><span class="s2">_index</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">payload-test</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">_type</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">_doc</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">_id</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">3</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">_score</span><span class="dl">"</span> <span class="p">:</span> <span class="mf">10.0</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">_source</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
          <span class="dl">"</span><span class="s2">key</span><span class="dl">"</span> <span class="p">:</span> <span class="p">[</span>
            <span class="dl">"</span><span class="s2">yellow|10 blue|2 red|4.3</span><span class="dl">"</span>
          <span class="p">]</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="dl">"</span><span class="s2">_index</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">payload-test</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">_type</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">_doc</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">_id</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">2</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">_score</span><span class="dl">"</span> <span class="p">:</span> <span class="mf">4.5</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">_source</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
          <span class="dl">"</span><span class="s2">key</span><span class="dl">"</span> <span class="p">:</span> <span class="p">[</span>
            <span class="dl">"</span><span class="s2">yellow|2 yellow|2.5 blue|1 red|5</span><span class="dl">"</span>
          <span class="p">]</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="dl">"</span><span class="s2">_index</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">payload-test</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">_type</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">_doc</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">_id</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">1</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">_score</span><span class="dl">"</span> <span class="p">:</span> <span class="mf">3.0</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">_source</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
          <span class="dl">"</span><span class="s2">key</span><span class="dl">"</span> <span class="p">:</span> <span class="p">[</span>
            <span class="dl">"</span><span class="s2">yellow|3 blue|1.1 red|1</span><span class="dl">"</span>
          <span class="p">]</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>잘 나온다. 성공이다~ 내용을 좀 더 훓어보면, <code class="language-plaintext highlighter-rouge">yellow</code>라는 키워드로 검색할 때, <code class="language-plaintext highlighter-rouge">score</code> 값이 <code class="language-plaintext highlighter-rouge">payload</code> 값으로 나오는 것을 확인 할 수 있다. 이때, <code class="language-plaintext highlighter-rouge">_id</code> = <code class="language-plaintext highlighter-rouge">2</code>인 문서는 <code class="language-plaintext highlighter-rouge">yellow</code> 키워드가 2개이고, 각각의 <code class="language-plaintext highlighter-rouge">payload</code> 값을 합산한 것이 <code class="language-plaintext highlighter-rouge">score</code>에 반영된 것을 알 수 있다.</p><h1 id="참조">참조</h1><ul><li>https://www.elastic.co/guide/en/elasticsearch/plugins/current/plugin-authors.html<li>https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-scripting-engine.html<li>https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-delimited-payload-tokenfilter.html<li>https://github.com/elastic/elasticsearch/tree/master/plugins/examples/script-expert-scoring<li>https://github.com/focuschange/elasticsearch-payload-score</ul><script async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8993100314477491" crossorigin="anonymous"></script><p><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8993100314477491" data-ad-slot="9549119208" data-ad-format="auto" data-full-width-responsive="true"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/search-engine/'>search-engine</a>, <a href='/categories/elasticsearch/'>elasticsearch</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/elasticsearch/" class="post-tag no-text-decoration" >elasticsearch,</a> <a href="/tags/elasticsearch6-5/" class="post-tag no-text-decoration" >elasticsearch6.5,</a> <a href="/tags/payload/" class="post-tag no-text-decoration" >payload,</a> <a href="/tags/payload-score/" class="post-tag no-text-decoration" >payload-score,</a> <a href="/tags/score/" class="post-tag no-text-decoration" >score,</a> <a href="/tags/ranking/" class="post-tag no-text-decoration" >ranking,</a> <a href="/tags/script-score/" class="post-tag no-text-decoration" >script-score</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"></div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=elasticsearch 6.5에서 payload scoring 구현하기 - 하얀눈길 블로그&url=https://www.irgroup.org/posts/payload-score-in-elasticsearch-6.5/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=elasticsearch 6.5에서 payload scoring 구현하기 - 하얀눈길 블로그&u=https://www.irgroup.org/posts/payload-score-in-elasticsearch-6.5/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=elasticsearch 6.5에서 payload scoring 구현하기 - 하얀눈길 블로그&url=https://www.irgroup.org/posts/payload-score-in-elasticsearch-6.5/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div><script src="https://utteranc.es/client.js" repo="focuschange/focuschange.github.io" issue-term="pathname" theme="github-light" crossorigin="anonymous" async> </script></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recent Update</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/usage-markdown/">jekyll에서 마크다운(Markdown) 사용하기</a><li><a href="/posts/jekyll-google-search/">Jekyll 테마에서 구글 검색 노출 등록하기</a><li><a href="/posts/fcm-app-server-1/">FCM push notification을 위한 앱서버 구현하기 1 - 기본개념 및 core</a><li><a href="/posts/Chirpy-%ED%85%8C%EB%A7%88-%EC%BB%A4%EC%8A%A4%ED%84%B0%EB%A7%88%EC%9D%B4%EC%A7%95/">Chirpy 테마 커스터마이징</a><li><a href="/posts/github-%EC%BB%B4%ED%93%A8%ED%84%B0-%ED%95%9C%EB%8C%80%EB%A1%9C-%EC%97%AC%EB%9F%AC-%EA%B3%84%EC%A0%95-%EC%82%AC%EC%9A%A9%ED%95%98%EA%B8%B0/">컴퓨터 한대로 github 여러 계정 사용하기</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/chirpy/">chirpy</a> <a class="post-tag" href="/tags/gcp/">gcp</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/app-engine/">app-engine</a> <a class="post-tag" href="/tags/jekyll/">jekyll</a> <a class="post-tag" href="/tags/github/">github</a> <a class="post-tag" href="/tags/embulk/">embulk</a> <a class="post-tag" href="/tags/fcm/">fcm</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/bigquery/">bigquery</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/jekyll-google-search/"><div class="card-body"> <em class="timeago small" date="2022-01-13 15:11:33 +0900" >Jan 13</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Jekyll 테마에서 구글 검색 노출 등록하기</h3><div class="text-muted small"><p> 구글에 검색을 통해 사이트로 인입되는 비율은 엄청납니다. 우리나라는 naver의 영향력이 막강하지만, 외부의 블로그나 사이트들은 그래도 구글을 통한 인입이 강력한 편입니다. jekyll 테마에서 구글 검색엔진에 포스트 글들이 검색되도록 설정해 보겠습니다. chirpy 기준이기는 하나 기본이 같기 때문에 쉽게 적용할 수 있을 겁니다. ...</p></div></div></a></div><div class="card"> <a href="/posts/github-%EC%BB%B4%ED%93%A8%ED%84%B0-%ED%95%9C%EB%8C%80%EB%A1%9C-%EC%97%AC%EB%9F%AC-%EA%B3%84%EC%A0%95-%EC%82%AC%EC%9A%A9%ED%95%98%EA%B8%B0/"><div class="card-body"> <em class="timeago small" date="2021-12-29 12:15:33 +0900" >Dec 29, 2021</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>컴퓨터 한대로 github 여러 계정 사용하기</h3><div class="text-muted small"><p> 컴퓨터 한 대에서 github 계정을 여러개 사용하다 보면 불편한 것이 이만저만이 아닙니다. ssh를 이용해서 host를 변경하고 키를 자동으로 인식하게 하면 너무나 편리하게 여러 계정을 사용할 수 있군요. 여러 계정 설정하기 ssh를 사용하여 github을 사용합니다. 계정별로 ssh key를 만들고 자동 로그인하도록 설정...</p></div></div></a></div><div class="card"> <a href="/posts/utternace-comments-system/"><div class="card-body"> <em class="timeago small" date="2021-12-26 14:15:33 +0900" >Dec 26, 2021</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Jekyll 테마에 utterances 댓글 연동하기</h3><div class="text-muted small"><p> Chirpy는 Disqus를 기본으로 지원합니다. 계정정보만 연동하면 잘 나옵니다. 전에 Disqus를 사용했었는데, 무료로 쓰던 기능들이 유료화 하면서 커스터마이징에 어려움이 있습니다. 그리고, UI도 좀 그러네요.. 그래서 다른 것을 알아보다가 Utterances를 알게 되었습니다. github의 이슈를 댓글로 표시하는 것으로 무료이면서 설치...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/mysql-login-path/" class="btn btn-outline-primary" prompt="Older"><p>MySQL Login path 설정하기</p></a> <a href="/posts/jekyll-chirpy/" class="btn btn-outline-primary" prompt="Newer"><p>Jekyll Chirpy 테마 사용하여 블로그 만들기</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://github.com/focuschange">하얀눈길</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">All rights reserved.</span></p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/chirpy/">chirpy</a> <a class="post-tag" href="/tags/gcp/">gcp</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/app-engine/">app-engine</a> <a class="post-tag" href="/tags/jekyll/">jekyll</a> <a class="post-tag" href="/tags/github/">github</a> <a class="post-tag" href="/tags/embulk/">embulk</a> <a class="post-tag" href="/tags/fcm/">fcm</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/bigquery/">bigquery</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-1872238-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-1872238-1'); }); </script> <script data-ad-client="ca-pub-8993100314477491" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
