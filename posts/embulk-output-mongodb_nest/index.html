<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="embulk mongodb output plugin 개발" /><meta name="author" content="하얀눈길" /><meta property="og:locale" content="en" /><meta name="description" content="embulk-output-mongodb 플러그인이 공식사이트에서 링크가 죽었군요. gem repository 에서 install은 가능하지만, 회사에서 사용하기 좀 뭐 해서 그냥 만들어 봤습니다. 참.. 쉽네요 😉" /><meta property="og:description" content="embulk-output-mongodb 플러그인이 공식사이트에서 링크가 죽었군요. gem repository 에서 install은 가능하지만, 회사에서 사용하기 좀 뭐 해서 그냥 만들어 봤습니다. 참.. 쉽네요 😉" /><link rel="canonical" href="https://www.irgroup.org/posts/embulk-output-mongodb_nest/" /><meta property="og:url" content="https://www.irgroup.org/posts/embulk-output-mongodb_nest/" /><meta property="og:site_name" content="하얀눈길 블로그" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2018-05-31T00:00:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="embulk mongodb output plugin 개발" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@하얀눈길" /><meta name="google-site-verification" content="i7DonAsg2XevX1vbo0yJyGpmzhwsylBrYop20xy_Z48" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"하얀눈길"},"headline":"embulk mongodb output plugin 개발","dateModified":"2021-12-27T18:05:38+09:00","datePublished":"2018-05-31T00:00:00+09:00","description":"embulk-output-mongodb 플러그인이 공식사이트에서 링크가 죽었군요. gem repository 에서 install은 가능하지만, 회사에서 사용하기 좀 뭐 해서 그냥 만들어 봤습니다. 참.. 쉽네요 😉","url":"https://www.irgroup.org/posts/embulk-output-mongodb_nest/","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.irgroup.org/posts/embulk-output-mongodb_nest/"},"@context":"https://schema.org"}</script><title>embulk mongodb output plugin 개발 | 하얀눈길 블로그</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="하얀눈길 블로그"><meta name="application-name" content="하얀눈길 블로그"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8993100314477491" crossorigin="anonymous"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/ir.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">하얀눈길 블로그</a></div><div class="site-subtitle" style="letter-spacing: -0.02em;">반갑습니다. 하얀눈길입니다.<br> 잊어버리기 전에 기록하려 합니다.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/focuschange" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://www.facebook.com/focuschange" aria-label="facebook" target="_blank" rel="noopener"> <i class="fab fa-facebook"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['focuschange','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>embulk mongodb output plugin 개발</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>embulk mongodb output plugin 개발</h1><div class="post-meta text-muted"><div> By <em> <a href="https://github.com/focuschange">하얀눈길</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" date="2018-05-31 00:00:00 +0900" data-toggle="tooltip" data-placement="bottom" title="Thu, May 31, 2018, 12:00 AM +0900" >May 31, 2018</em> </span> <span> Updated <em class="timeago" date="2021-12-27 18:05:38 +0900 " data-toggle="tooltip" data-placement="bottom" title="Mon, Dec 27, 2021, 6:05 PM +0900" >Dec 27, 2021</em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2634 words"> <em>14 min</em> read</span></div></div></div><div class="post-content"><blockquote><p>embulk-output-mongodb 플러그인이 공식사이트에서 링크가 죽었군요. gem repository 에서 install은 가능하지만, 회사에서 사용하기 좀 뭐 해서 그냥 만들어 봤습니다. 참.. 쉽네요 😉</p></blockquote><div class="card"> <script async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8993100314477491" crossorigin="anonymous"></script> <ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-8993100314477491" data-ad-slot="6115278830"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script></div><h2 id="개발-방법">개발 방법<a href="#개발-방법"><i class="fas fa-hashtag"></i></a></h2></h2><ol><li>embulk 신규 프로젝트 생성<li>프로젝트 빌딩<li>작업결과 확인<li>mongodb client 코드 작성</ol><h2 id="1-embulk로-신규-프로젝트-생성">1. embulk로 신규 프로젝트 생성<a href="#1-embulk로-신규-프로젝트-생성"><i class="fas fa-hashtag"></i></a></h2></h2><p>embulk가 기본적인 플러그인 프로젝트의 템플릿 코드 및 프로젝트 자체를 만들어 줍니다. 상당히 간편하더군요. java와 ruby 두가지이니 입맛에 맞게 선택해서 만들면 되구요. 저는 java로 만들어 봤습니다.</p><p>아래 명령으로 간단히 생성 됩니다.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>$ embulk new &lt;type&gt; &lt;name&gt;
</pre></table></code></div></div><p>type은 아래와 같습니다.</p><div class="table-wrapper"><table><thead><tr><th>type<th>description<th>example<tbody><tr><td>java-input<td>Java record input plugin<td>mysql<tr><td>java-output<td>Java record output plugin<td>mysql<tr><td>java-filter<td>Java record filter plugin<td>add-hostname<tr><td>java-file-input<td>Java file input plugin<td>ftp<tr><td>java-file-output<td>Java file output plugin<td>ftp<tr><td>java-parser<td>Java file parser plugin<td>csv<tr><td>java-formatter<td>Java file formatter plugin<td>csv<tr><td>java-decoder<td>Java file decoder plugin<td>gzip<tr><td>java-encoder<td>Java file encoder plugin<td>gzip<tr><td>ruby-input<td>Ruby record input plugin<td>mysql<tr><td>ruby-output<td>Ruby record output plugin<td>mysql<tr><td>ruby-filter<td>Ruby record filter plugin<td>add-hostname<tr><td>ruby-parser<td>Ruby file parser plugin<td>csv<tr><td>ruby-formatter<td>Ruby file formatter plugin<td>csv</table></div><p>java output plugin을 만들거니 다음과 같이 입력하였습니다.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>$ embulk new java-output embulk_nest
</pre></table></code></div></div><p>plugin 명칭을 “embulk_nest”로 잡았습니다. 나중에 실행시킬때는 “embulk-output-embulk_nest”로 될 것이기에, 중간에 “_“를 넣었습니다.</p><h2 id="2-프로젝트-빌딩">2. 프로젝트 빌딩<a href="#2-프로젝트-빌딩"><i class="fas fa-hashtag"></i></a></h2></h2><p>간단히 프로젝트가 생성되면, 다음 명령을 통해 빌딩할 수 있습니다.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>$ cd embulk-output-embulk_nest
$ ./gradlew package
</pre></table></code></div></div><p>gradle을 사용하고 있어서 intellij에서 직접하려 했는데, 세팅이 잘 안 맞네요. 그냥 커맨드 라인에서 작업하는 것이 편합니다.</p><h2 id="3-작업-결과-확인">3. 작업 결과 확인<a href="#3-작업-결과-확인"><i class="fas fa-hashtag"></i></a></h2></h2><p>패키지가 만들어졌으면 작업 내용을 확인할 수 있습니다.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>$ embulk run -L ./embulk-output-mongodb_nest config.yml
</pre></table></code></div></div><p>config.yml을 대충 만들어서 돌려보니 그냥 잘 돌아 갑니다. 물론 아무 작업도 안하지만서도..</p><p>여기까지 됐으면 거의 끝났다고 보면 됩니다.</p><h2 id="4-mongodb-client-코드-작성">4. mongodb client 코드 작성<a href="#4-mongodb-client-코드-작성"><i class="fas fa-hashtag"></i></a></h2></h2><p><strong>MongodbNestOutputPlugin.java 수정</strong></p><p>사실 mongodb를 사용해 보지 않아서 오히려 여기부터 좀 시간을 잡아먹었습니다. 애초부터 mysql같은 플랫한 데이터를 sub document가 가능하게 mongodb로 넣기 위한 작업이었기에 좀 헤맸네요. 아무튼 아래 소스에 코딩을 시작하면 됩니다.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>파일 위치 : src/org/embulk/*
</pre></table></code></div></div><p>실제 수정할 파일은 다음과 같이 만들어져 있네요.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>src/main/java/org/embulk/output/mongodb_nest/MongodbNestOutputPlugin.java
</pre></table></code></div></div><p>탬플릿에는 몇개의 메소드와 인터페이스가 만들어져 있습니다.</p><div class="table-wrapper"><table><thead><tr><th>메소드<th>기능<tbody><tr><td>PluginTask<td>config.yml의 설정값을 입력받기 위한 인터페이스<tr><td>transaction<td>transaction을 수행하기 위한 기본 메소드<tr><td>resume<td>resume을 구현하기 위한 메소드<tr><td>cleanup<td>cleanup을 구현하기 위한 메소드<tr><td>open<td>실제 output plugin의 작업을 수행하기 위한 메소드</table></div><p>mongodb의 기본적인 설정 정보를 담기 위해 PluginTask interface를 다음과 같이 수정하였습니다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre><td class="rouge-code"><pre> <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">DefineChildDocument</span> <span class="kd">extends</span> <span class="nc">Task</span>  
   <span class="o">{</span>  
      <span class="nd">@Config</span><span class="o">(</span><span class="s">"name"</span><span class="o">)</span>  
      <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getName</span><span class="o">();</span>  
  
  <span class="nd">@Config</span><span class="o">(</span><span class="s">"field"</span><span class="o">)</span>  
      <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getField</span><span class="o">();</span>  
  <span class="o">}</span>  
  
   <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PluginTask</span> <span class="kd">extends</span> <span class="nc">Task</span>  
   <span class="o">{</span>  
      <span class="nd">@Config</span><span class="o">(</span><span class="s">"collection"</span><span class="o">)</span>  
      <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getCollection</span><span class="o">();</span>  
  
  <span class="nd">@Config</span><span class="o">(</span><span class="s">"host"</span><span class="o">)</span>  
      <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getHost</span><span class="o">();</span>  
  
  <span class="nd">@Config</span><span class="o">(</span><span class="s">"port"</span><span class="o">)</span>  
      <span class="nd">@ConfigDefault</span><span class="o">(</span><span class="s">"27017"</span><span class="o">)</span>  
      <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getPort</span><span class="o">();</span>  
  
  <span class="nd">@Config</span><span class="o">(</span><span class="s">"database"</span><span class="o">)</span>  
      <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getDatabase</span><span class="o">();</span>  
  
  <span class="nd">@Config</span><span class="o">(</span><span class="s">"user"</span><span class="o">)</span>  
      <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getUser</span><span class="o">();</span>  
  
  <span class="nd">@Config</span><span class="o">(</span><span class="s">"password"</span><span class="o">)</span>  
      <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getPassword</span><span class="o">();</span>  
  
  <span class="nd">@Config</span><span class="o">(</span><span class="s">"key"</span><span class="o">)</span>  
      <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getKey</span><span class="o">();</span>  
  
  <span class="nd">@Config</span><span class="o">(</span><span class="s">"child"</span><span class="o">)</span>  
      <span class="nd">@ConfigDefault</span><span class="o">(</span><span class="s">"null"</span><span class="o">)</span>  
      <span class="kd">public</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">DefineChildDocument</span><span class="o">&gt;&gt;</span> <span class="nf">getChild</span><span class="o">();</span>  
  
  <span class="nd">@Config</span><span class="o">(</span><span class="s">"bulk_size"</span><span class="o">)</span>  
      <span class="nd">@ConfigDefault</span><span class="o">(</span><span class="s">"1000"</span><span class="o">)</span>  
      <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getBulkSize</span><span class="o">();</span>  
  
  <span class="o">}</span>  

</pre></table></code></div></div><p>참고할 점은 선택 옵션인 경우는 “@ConfigDefault”를 작성해 주면 된다는 것입니다. 없는 경우는 필수 항목이 되어 반드시 config.yml에 있어야 합니다. 주의할 것은, 선택항목인데, 기본값이 필요 없는 경우는 “null”로 주면 됩니다. “” 이런식으로 주면 에러가 나더군요</p><p>mongodb 접속 정보를 url로 입력할 수도 있는데, 문제는 ‘@’와 같은 특수문자가 기본 정보에 들어 있으면 mongodb client에서 에러가 납니다. url encoding을 하면 되는데, 좀 더 편리하게 하려고, 필드들을 모두 잘라서 입력하도록 했습니다.</p><p>기본적인 접속 정보와 함께, child라는 필드를 추가했습니다. nested 되는 도큐멘트를 정의하기 위함이구요. name으로 sub document 필드명을, field로 input에서 받은 필드명을 입력하도록 하였습니다. 같은 name이 설정될 경우는 하나의 sub document에 들어가도록 구성하였습니다.</p><p>두번째로 bulk_size를 만들었는데, 시스템 자원에 따라 알아서 쓰면 되겠지요.</p><p>config는 잡았으니.. 실제 수행할 몸체를 구현하면 되겠지요.</p><p>open 메소드를 아래와 같이 수정하였습니다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nd">@Override</span> 
<span class="kd">public</span> <span class="nc">TransactionalPageOutput</span> <span class="nf">open</span><span class="o">(</span><span class="nc">TaskSource</span> <span class="n">taskSource</span><span class="o">,</span> <span class="nc">Schema</span> <span class="n">schema</span><span class="o">,</span> <span class="kt">int</span> <span class="n">taskIndex</span><span class="o">)</span>  
<span class="o">{</span>  
   <span class="nc">PluginTask</span> <span class="n">task</span> <span class="o">=</span> <span class="n">taskSource</span><span class="o">.</span><span class="na">loadTask</span><span class="o">(</span><span class="nc">PluginTask</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>  
  
 <span class="k">return</span> <span class="k">new</span> <span class="nf">PluginPageOutput</span><span class="o">(</span><span class="n">task</span><span class="o">,</span> <span class="n">schema</span><span class="o">);</span>  
<span class="o">}</span>
</pre></table></code></div></div><p><strong>PluginPageOutput.java 추가</strong></p><p>PluginPageOutput 클래스는 TransactionalPageOutput 클래스를 상속받아 아래와 같이 구현하였습니다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">org.embulk.output.mongodb_nest</span><span class="o">;</span>  
  
<span class="kn">import</span> <span class="nn">com.mongodb.BasicDBObject</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">com.mongodb.client.MongoClient</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">com.mongodb.client.MongoClients</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">com.mongodb.client.MongoCollection</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">com.mongodb.client.MongoDatabase</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">com.mongodb.client.model.ReplaceOneModel</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">com.mongodb.client.model.ReplaceOptions</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">com.mongodb.client.model.WriteModel</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">org.bson.Document</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">org.embulk.config.TaskReport</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">org.embulk.spi.*</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">org.embulk.spi.time.Timestamp</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="o">;</span>  
  
<span class="kn">import</span> <span class="nn">java.io.UnsupportedEncodingException</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">java.net.URLEncoder</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>  
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>  
  
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PluginPageOutput</span> <span class="kd">implements</span> <span class="nc">TransactionalPageOutput</span>  
<span class="o">{</span>  
   <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">Exec</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">MongodbNestOutputPlugin</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>  
  
 <span class="kd">private</span> <span class="kd">final</span> <span class="nc">MongodbNestOutputPlugin</span><span class="o">.</span><span class="na">PluginTask</span> <span class="n">task</span><span class="o">;</span>  
 <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Schema</span>                             <span class="n">schema</span><span class="o">;</span>  
 <span class="kd">private</span> <span class="kd">final</span> <span class="nc">PageReader</span>                         <span class="n">pageReader</span><span class="o">;</span>  
  
 <span class="kd">private</span> <span class="nc">MongoClient</span>               <span class="n">mongo</span><span class="o">;</span>  
 <span class="kd">private</span> <span class="nc">MongoDatabase</span>             <span class="n">db</span><span class="o">;</span>  
 <span class="kd">private</span> <span class="nc">MongoCollection</span><span class="o">&lt;</span><span class="nc">Document</span><span class="o">&gt;</span> <span class="n">collection</span><span class="o">;</span>  
  
  <span class="nc">PluginPageOutput</span><span class="o">(</span><span class="nc">MongodbNestOutputPlugin</span><span class="o">.</span><span class="na">PluginTask</span> <span class="n">task</span><span class="o">,</span> <span class="nc">Schema</span> <span class="n">schema</span><span class="o">)</span>  
   <span class="o">{</span>  
      <span class="k">this</span><span class="o">.</span><span class="na">pageReader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PageReader</span><span class="o">(</span><span class="n">schema</span><span class="o">);</span>  
 <span class="k">this</span><span class="o">.</span><span class="na">schema</span> <span class="o">=</span> <span class="n">schema</span><span class="o">;</span>  
 <span class="k">this</span><span class="o">.</span><span class="na">task</span> <span class="o">=</span> <span class="n">task</span><span class="o">;</span>  
  
  <span class="nc">String</span> <span class="n">connectionStr</span> <span class="o">=</span> <span class="s">"mongodb://"</span><span class="o">;</span>  
  
 <span class="k">if</span> <span class="o">(</span><span class="n">task</span><span class="o">.</span><span class="na">getUser</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>  
      <span class="o">{</span>  
         <span class="n">connectionStr</span> <span class="o">+=</span> <span class="n">task</span><span class="o">.</span><span class="na">getUser</span><span class="o">();</span>  
 <span class="k">try</span>  <span class="o">{</span>  
            <span class="n">connectionStr</span> <span class="o">+=</span> <span class="s">":"</span> <span class="o">+</span> <span class="nc">URLEncoder</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="n">task</span><span class="o">.</span><span class="na">getPassword</span><span class="o">(),</span> <span class="s">"UTF-8"</span><span class="o">)</span> <span class="o">+</span> <span class="s">"@"</span><span class="o">;</span>  
  <span class="o">}</span>  
         <span class="k">catch</span> <span class="o">(</span><span class="nc">UnsupportedEncodingException</span> <span class="n">e</span><span class="o">)</span>  
         <span class="o">{</span>  
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>  
  <span class="o">}</span>  
      <span class="o">}</span>  
  
      <span class="n">connectionStr</span> <span class="o">+=</span> <span class="n">task</span><span class="o">.</span><span class="na">getHost</span><span class="o">()</span> <span class="o">+</span> <span class="s">":"</span> <span class="o">+</span> <span class="n">task</span><span class="o">.</span><span class="na">getPort</span><span class="o">()</span> <span class="o">+</span> <span class="s">"/"</span> <span class="o">+</span> <span class="n">task</span><span class="o">.</span><span class="na">getDatabase</span><span class="o">();</span>  
  
 <span class="k">this</span><span class="o">.</span><span class="na">mongo</span> <span class="o">=</span> <span class="nc">MongoClients</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">connectionStr</span><span class="o">);</span>  
 <span class="k">this</span><span class="o">.</span><span class="na">db</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">mongo</span><span class="o">.</span><span class="na">getDatabase</span><span class="o">(</span><span class="n">task</span><span class="o">.</span><span class="na">getDatabase</span><span class="o">());</span>  
 <span class="k">this</span><span class="o">.</span><span class="na">collection</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">db</span><span class="o">.</span><span class="na">getCollection</span><span class="o">(</span><span class="n">task</span><span class="o">.</span><span class="na">getCollection</span><span class="o">());</span>  
  <span class="o">}</span>  
  
   <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="nc">Page</span> <span class="n">page</span><span class="o">)</span>  
   <span class="o">{</span>  
      <span class="n">pageReader</span><span class="o">.</span><span class="na">setPage</span><span class="o">(</span><span class="n">page</span><span class="o">);</span>  
  <span class="nc">List</span><span class="o">&lt;</span><span class="nc">WriteModel</span><span class="o">&lt;</span><span class="nc">Document</span><span class="o">&gt;&gt;</span> <span class="n">replaceModel</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>  
  
 <span class="k">while</span> <span class="o">(</span><span class="n">pageReader</span><span class="o">.</span><span class="na">nextRecord</span><span class="o">())</span>  
      <span class="o">{</span>  
         <span class="nc">BasicDBObject</span> <span class="n">doc</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BasicDBObject</span><span class="o">();</span>  
  
 <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">schema</span><span class="o">.</span><span class="na">getColumnCount</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span>  
         <span class="o">{</span>  
            <span class="nc">String</span> <span class="n">t</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="na">getColumnName</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>  
  <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">type</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="na">getColumnType</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">getJavaType</span><span class="o">();</span>  
  
 <span class="k">if</span> <span class="o">(</span><span class="n">pageReader</span><span class="o">.</span><span class="na">isNull</span><span class="o">(</span><span class="n">i</span><span class="o">))</span>  
            <span class="o">{</span>  
               <span class="n">doc</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>  
  <span class="o">}</span>  
            <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">type</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="kt">boolean</span><span class="o">.</span><span class="na">class</span><span class="o">))</span>  
            <span class="o">{</span>  
               <span class="n">doc</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">pageReader</span><span class="o">.</span><span class="na">getBoolean</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>  
  <span class="o">}</span>  
            <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">type</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="kt">double</span><span class="o">.</span><span class="na">class</span><span class="o">))</span>  
            <span class="o">{</span>  
               <span class="n">doc</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">pageReader</span><span class="o">.</span><span class="na">getDouble</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>  
  <span class="o">}</span>  
            <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">type</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="kt">long</span><span class="o">.</span><span class="na">class</span><span class="o">))</span>  
            <span class="o">{</span>  
               <span class="n">doc</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">pageReader</span><span class="o">.</span><span class="na">getLong</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>  
  <span class="o">}</span>  
            <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">type</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">))</span>  
            <span class="o">{</span>  
               <span class="n">doc</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">pageReader</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>  
  <span class="o">}</span>  
            <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">type</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="nc">Timestamp</span><span class="o">.</span><span class="na">class</span><span class="o">))</span>  
            <span class="o">{</span>  
               <span class="n">doc</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">Timestamp</span><span class="o">(</span><span class="n">pageReader</span><span class="o">.</span><span class="na">getTimestamp</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">toEpochMilli</span><span class="o">()));</span>  
  <span class="o">}</span>  
         <span class="o">}</span>  
  
         <span class="k">if</span> <span class="o">(</span><span class="n">task</span><span class="o">.</span><span class="na">getChild</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>  
         <span class="o">{</span>  
            <span class="n">doc</span> <span class="o">=</span> <span class="n">transformDocument</span><span class="o">(</span><span class="n">doc</span><span class="o">);</span>  
  <span class="o">}</span>  
  
         <span class="n">replaceModel</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">ReplaceOneModel</span><span class="o">&lt;&gt;(</span>  
               <span class="k">new</span> <span class="nf">Document</span><span class="o">(</span><span class="n">task</span><span class="o">.</span><span class="na">getKey</span><span class="o">(),</span> <span class="n">doc</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">task</span><span class="o">.</span><span class="na">getKey</span><span class="o">())),</span>  
 <span class="k">new</span> <span class="nf">Document</span><span class="o">(</span><span class="n">doc</span><span class="o">),</span>  
 <span class="k">new</span> <span class="nf">ReplaceOptions</span><span class="o">().</span><span class="na">upsert</span><span class="o">(</span><span class="kc">true</span><span class="o">))</span>  
         <span class="o">);</span>  
  
 <span class="k">if</span><span class="o">(</span><span class="n">replaceModel</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">%</span> <span class="n">task</span><span class="o">.</span><span class="na">getBulkSize</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>  
         <span class="o">{</span>  
            <span class="n">collection</span><span class="o">.</span><span class="na">bulkWrite</span><span class="o">(</span><span class="n">replaceModel</span><span class="o">);</span>  
  <span class="n">replaceModel</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>  
  <span class="o">}</span>  
      <span class="o">}</span>  
  
      <span class="k">if</span> <span class="o">(</span><span class="n">replaceModel</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span>  
      <span class="o">{</span>  
         <span class="n">collection</span><span class="o">.</span><span class="na">bulkWrite</span><span class="o">(</span><span class="n">replaceModel</span><span class="o">);</span>  
  <span class="o">}</span>  
  
   <span class="o">}</span>  
  
   <span class="kd">private</span> <span class="nc">BasicDBObject</span> <span class="nf">transformDocument</span><span class="o">(</span><span class="nc">BasicDBObject</span> <span class="n">doc</span><span class="o">)</span>  
   <span class="o">{</span>  
      <span class="k">for</span> <span class="o">(</span><span class="nc">MongodbNestOutputPlugin</span><span class="o">.</span><span class="na">DefineChildDocument</span> <span class="n">cd</span> <span class="o">:</span> <span class="n">task</span><span class="o">.</span><span class="na">getChild</span><span class="o">().</span><span class="na">get</span><span class="o">())</span>  
      <span class="o">{</span>  
         <span class="nc">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">cd</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>  
  <span class="nc">String</span> <span class="n">field</span> <span class="o">=</span> <span class="n">cd</span><span class="o">.</span><span class="na">getField</span><span class="o">();</span>  
  
  <span class="nc">BasicDBObject</span> <span class="n">subdoc</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BasicDBObject</span><span class="o">();</span>  
  <span class="nc">Object</span> <span class="n">exists</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>  
  
 <span class="k">if</span> <span class="o">(</span><span class="n">exists</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>  
         <span class="o">{</span>  
            <span class="n">subdoc</span><span class="o">.</span><span class="na">putAll</span><span class="o">((</span><span class="nc">Map</span><span class="o">)</span> <span class="n">exists</span><span class="o">);</span>  
  <span class="o">}</span>  
  
         <span class="n">subdoc</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">field</span><span class="o">,</span> <span class="n">doc</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">field</span><span class="o">));</span>  
  <span class="n">doc</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">subdoc</span><span class="o">);</span>  
  <span class="o">}</span>  
  
      <span class="k">return</span> <span class="n">doc</span><span class="o">;</span>  
  <span class="o">}</span>  
  
   <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">finish</span><span class="o">()</span>  
   <span class="o">{</span>  
  
   <span class="o">}</span>  
  
   <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">close</span><span class="o">()</span>  
   <span class="o">{</span>  
      <span class="k">this</span><span class="o">.</span><span class="na">mongo</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>  
  <span class="o">}</span>  
  
   <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">abort</span><span class="o">()</span>  
   <span class="o">{</span>  
  
   <span class="o">}</span>  
  
   <span class="nd">@Override</span> <span class="kd">public</span> <span class="nc">TaskReport</span> <span class="nf">commit</span><span class="o">()</span>  
   <span class="o">{</span>  
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>  
  <span class="o">}</span>  
<span class="o">}</span>
</pre></table></code></div></div><p><em>음.. 이노무 블로그는 소스 폴딩이 안돼!! 누가 도움 좀..</em> :sob:</p><p>TransactionalPageOutput 클래스를 상속받아 코드를 생성하여, 몇몇 필수 메소드를 override하여 작성합니다.</p><p>생성자에서 mongodb에 접속하도록 하였고, add method에서 필요한 작업을 수행했습니다.</p><p>sub document를 만들기 위해, transformDocument 메소드를 추가해서 구조를 변형하였습니다.</p><p><em>사실, 코딩 능력이 일천하여 하나하나 설명하기가 좀.. 그러네요. (뭐.. 나만 알면 되지~ :kissing_smiling_eyes:</em></p><p><strong>config.yml 작성</strong></p><p>테스트를 위해서, embulk의 샘플 csv를 input으로하여 작성해 봤습니다.</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre><span class="na">in</span><span class="pi">:</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">file</span>
  <span class="na">path_prefix</span><span class="pi">:</span> <span class="s">/Users/focuschange/google/program/embulk/./try1/csv/sample_</span>
  <span class="na">decoders</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="pi">{</span><span class="nv">type</span><span class="pi">:</span> <span class="nv">gzip</span><span class="pi">}</span>
  <span class="na">parser</span><span class="pi">:</span>
    <span class="na">charset</span><span class="pi">:</span> <span class="s">UTF-8</span>
    <span class="na">newline</span><span class="pi">:</span> <span class="s">LF</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">csv</span>
    <span class="na">delimiter</span><span class="pi">:</span> <span class="s1">'</span><span class="s">,'</span>
    <span class="na">quote</span><span class="pi">:</span> <span class="s1">'</span><span class="s">"'</span>
    <span class="na">escape</span><span class="pi">:</span> <span class="s1">'</span><span class="s">"'</span>
    <span class="na">null_string</span><span class="pi">:</span> <span class="s1">'</span><span class="s">NULL'</span>
    <span class="na">trim_if_not_quoted</span><span class="pi">:</span> <span class="no">false</span>
    <span class="na">skip_header_lines</span><span class="pi">:</span> <span class="m">1</span>
    <span class="na">allow_extra_columns</span><span class="pi">:</span> <span class="no">false</span>
    <span class="na">allow_optional_columns</span><span class="pi">:</span> <span class="no">false</span>
    <span class="na">columns</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="pi">{</span><span class="nv">name</span><span class="pi">:</span> <span class="nv">id</span><span class="pi">,</span> <span class="nv">type</span><span class="pi">:</span> <span class="nv">long</span><span class="pi">}</span>
    <span class="pi">-</span> <span class="pi">{</span><span class="nv">name</span><span class="pi">:</span> <span class="nv">account</span><span class="pi">,</span> <span class="nv">type</span><span class="pi">:</span> <span class="nv">long</span><span class="pi">}</span>
    <span class="pi">-</span> <span class="pi">{</span><span class="nv">name</span><span class="pi">:</span> <span class="nv">time</span><span class="pi">,</span> <span class="nv">type</span><span class="pi">:</span> <span class="nv">timestamp</span><span class="pi">,</span> <span class="nv">format</span><span class="pi">:</span> <span class="s1">'</span><span class="s">%Y-%m-%d</span><span class="nv"> </span><span class="s">%H:%M:%S'</span><span class="pi">}</span>
    <span class="pi">-</span> <span class="pi">{</span><span class="nv">name</span><span class="pi">:</span> <span class="nv">purchase</span><span class="pi">,</span> <span class="nv">type</span><span class="pi">:</span> <span class="nv">timestamp</span><span class="pi">,</span> <span class="nv">format</span><span class="pi">:</span> <span class="s1">'</span><span class="s">%Y%m%d'</span><span class="pi">}</span>
    <span class="pi">-</span> <span class="pi">{</span><span class="nv">name</span><span class="pi">:</span> <span class="nv">comment</span><span class="pi">,</span> <span class="nv">type</span><span class="pi">:</span> <span class="nv">string</span><span class="pi">}</span>
<span class="na">out</span><span class="pi">:</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">mongodb_nest</span>
  <span class="na">host</span><span class="pi">:</span> <span class="s">999.999.999.999</span>
<span class="c1">#  port: 27017</span>
  <span class="na">database</span><span class="pi">:</span> <span class="s">focus</span>
  <span class="na">user</span><span class="pi">:</span> <span class="s">focus</span>
  <span class="na">password</span><span class="pi">:</span> <span class="s">focus@123.456.789</span>
  <span class="na">collection</span><span class="pi">:</span> <span class="s">PluginTest</span>
  <span class="na">key</span><span class="pi">:</span> <span class="s">account</span>
  <span class="na">child</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="pi">{</span><span class="nv">name</span><span class="pi">:</span> <span class="nv">mychild</span><span class="pi">,</span> <span class="nv">field</span><span class="pi">:</span> <span class="nv">time</span><span class="pi">}</span>
  <span class="pi">-</span> <span class="pi">{</span><span class="nv">name</span><span class="pi">:</span> <span class="nv">yourchild</span><span class="pi">,</span> <span class="nv">field</span><span class="pi">:</span> <span class="nv">comment</span><span class="pi">}</span>
  <span class="pi">-</span> <span class="pi">{</span><span class="nv">name</span><span class="pi">:</span> <span class="nv">mychild</span><span class="pi">,</span> <span class="nv">field</span><span class="pi">:</span> <span class="nv">purchase</span><span class="pi">}</span>
</pre></table></code></div></div><p>실제 로컬에서 수행해 보니, mongodb에 다음과 같이 들어갑니다.</p><p><img data-proofer-ignore data-src="http://www.irgroup.org/assets/img/embulk_output_mongodb_nest_test.jpg" alt="enter image description here" /></p><p>child 필드로 작성한 mychild, yourchild 모두 잘 들어갔네요. 아무튼 간단히 작성해서 테스트 해 보니 잘 들어갑니다.</p><h2 id="5-배포">5. 배포<a href="#5-배포"><i class="fas fa-hashtag"></i></a></h2></h2><p>하는김에 젬 배포까지 해 봤습니다. https://rubygems.org 에 가입하고, console에서 배포하기 위해 인증까지 받았습니다.</p><p>console 인증은 그냥 다음처럼 했습니다.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre> <span class="nv">$ </span>gem push
Enter your RubyGems.org credentials.
Don<span class="s1">'t have an account yet? Create one at https://rubygems.org/sign_up
   Email:   focuschange@gmail.com
Password:

Signed in.
ERROR:  While executing gem ... (Gem::CommandLineError)
    Please specify a gem name on the command line (e.g. gem build GEMNAME)
</span></pre></table></code></div></div><p>email과 암호를 입력하니 siged in 성공하고, “~/.gem/credentials” 파일이 생성됩니다. 뭐.. 다음 에러야 무시하고.. 인증받았으면 됐고~</p><p>아래 명령으로 gem push 하면 빌딩 및 배포가 이루어집니다,</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="nv">$ </span>./gradlew gemPush
....
....
<span class="o">&gt;</span> Task :gem
  Successfully built RubyGem
  Name: embulk-output-mongodb_nest
  Version: 0.1.0
  File: embulk-output-mongodb_nest-0.1.0.gem

<span class="o">&gt;</span> Task :gemPush
Pushing gem to https://rubygems.org...
Successfully registered gem: embulk-output-mongodb_nest <span class="o">(</span>0.1.0<span class="o">)</span>
</pre></table></code></div></div><p>필요한 모듈들 다운받아 패키징하고, 위에 메세지처럼 gem에 올라가네요.</p><p>https://rubygems.org 에서 검색해보니, 나옵니다. 와~~</p><h2 id="6-결론">6. 결론<a href="#6-결론"><i class="fas fa-hashtag"></i></a></h2></h2><p>embulk는 사용하면 할 수록 참 편하다는 생각이 드네요. custom도 상당히 쉬운 편이구요. 아직 몽고DB를 능숙하게 사용하지 못하기 때문에, 코드가 좀 지저분하지만, 점진적으로 가다듬으면 쓰는데 나쁘지 않을 것 같습니다. 오히려 회사에서 방화벽 열고, 이것저것 준비하는 시간이 더 걸립니다.</p><h2 id="참고">참고<a href="#참고"><i class="fas fa-hashtag"></i></a></h2></h2><ul><li><strong>소스코드</strong> : https://github.com/focuschange/embulk-output-mongodb_nest<li><strong>ruby gem</strong> : https://rubygems.org/gems/embulk-output-mongodb_nest<li><strong>embulk customization</strong> : http://www.embulk.org/docs/customization.html</ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/tools/'>tools</a>, <a href='/categories/embulk/'>embulk</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/embulk/" class="post-tag no-text-decoration" >embulk</a> <a href="/tags/embulk-output-mongodb-nest/" class="post-tag no-text-decoration" >embulk-output-mongodb_nest</a> <a href="/tags/mongodb/" class="post-tag no-text-decoration" >mongodb</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"></div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=embulk mongodb output plugin 개발 - 하얀눈길 블로그&url=https://www.irgroup.org/posts/embulk-output-mongodb_nest/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=embulk mongodb output plugin 개발 - 하얀눈길 블로그&u=https://www.irgroup.org/posts/embulk-output-mongodb_nest/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=embulk mongodb output plugin 개발 - 하얀눈길 블로그&url=https://www.irgroup.org/posts/embulk-output-mongodb_nest/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div><script src="https://utteranc.es/client.js" repo="focuschange/focuschange.github.io" issue-term="pathname" theme="github-light" crossorigin="anonymous" async> </script></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recent Update</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/usage-markdown/">jekyll에서 마크다운(Markdown) 사용하기</a><li><a href="/posts/jekyll-google-search/">Jekyll 테마에서 구글 검색 노출 등록하기</a><li><a href="/posts/fcm-app-server-1/">FCM push notification을 위한 앱서버 구현하기 1 - 기본개념 및 core</a><li><a href="/posts/Chirpy-%ED%85%8C%EB%A7%88-%EC%BB%A4%EC%8A%A4%ED%84%B0%EB%A7%88%EC%9D%B4%EC%A7%95/">Chirpy 테마 커스터마이징</a><li><a href="/posts/github-%EC%BB%B4%ED%93%A8%ED%84%B0-%ED%95%9C%EB%8C%80%EB%A1%9C-%EC%97%AC%EB%9F%AC-%EA%B3%84%EC%A0%95-%EC%82%AC%EC%9A%A9%ED%95%98%EA%B8%B0/">컴퓨터 한대로 github 여러 계정 사용하기</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/chirpy/">chirpy</a> <a class="post-tag" href="/tags/gcp/">gcp</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/app-engine/">app-engine</a> <a class="post-tag" href="/tags/jekyll/">jekyll</a> <a class="post-tag" href="/tags/github/">github</a> <a class="post-tag" href="/tags/embulk/">embulk</a> <a class="post-tag" href="/tags/fcm/">fcm</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/bigquery/">bigquery</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/embulk-bigquery-output/"><div class="card-body"> <em class="timeago small" date="2018-05-11 10:59:10 +0900" >May 11, 2018</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>embulk를 사용한 vertica to bigquery 방법</h3><div class="text-muted small"><p> 다른 플랫폼간에 데이터 전송이나 ETL을 위해서 여러가지 툴이 존재한다고 합니다. 그 중 embulk를 소개받게 되어 사용성 테스트를 해 봤습니다. 물론 많은 툴을 써본 경험은 없으나, embulk는 물건인 듯 싶습니다. 설치부터 데이터 전송까지 단계적으로 기록해 보려 합니다. macOS High Sierra 기준입니다. 1...</p></div></div></a></div><div class="card"> <a href="/posts/mysql-login-path/"><div class="card-body"> <em class="timeago small" date="2018-11-13 00:00:00 +0900" >Nov 13, 2018</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>MySQL Login path 설정하기</h3><div class="text-muted small"><p> mysql 5.6부터 보안 문제로 인해 패스워드를 커맨드라인에서 직접 입력하기 어려워졌습니다. 대신에 login path라는 것을 사용하면 되는데요. 커맨드를 자주 잊어버리네요. “Warning: using a password on the command line interface can be insecure. “ 이런 메세지가 출력될 때 사용하...</p></div></div></a></div><div class="card"> <a href="/posts/favorite-tools/"><div class="card-body"> <em class="timeago small" date="2018-05-18 00:00:00 +0900" >May 18, 2018</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>개발에 유용한 툴들</h3><div class="text-muted small"><p> 가끔 장비를 교체하는 경우 전에 설치했던 툴들이 기억이 나지 않을 때가 있습니다. 세월이 갈수록 점점.. 더.. 그래서 내가 사용하는 툴 목록을 정리해 두려 합니다. DB Client MYSQL MySQL WorkBench - https://www.mysql.com/products/workbench/ :-1: HeidiS...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/favorite-tools/" class="btn btn-outline-primary" prompt="Older"><p>개발에 유용한 툴들</p></a> <a href="/posts/gcp-favorate-url/" class="btn btn-outline-primary" prompt="Newer"><p>gcp 유용한 정보들</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://github.com/focuschange">하얀눈길</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">All rights reserved.</span></p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/chirpy/">chirpy</a> <a class="post-tag" href="/tags/gcp/">gcp</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/app-engine/">app-engine</a> <a class="post-tag" href="/tags/jekyll/">jekyll</a> <a class="post-tag" href="/tags/github/">github</a> <a class="post-tag" href="/tags/embulk/">embulk</a> <a class="post-tag" href="/tags/fcm/">fcm</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/bigquery/">bigquery</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-1872238-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-1872238-1'); }); </script> <script data-ad-client="ca-pub-8993100314477491" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
